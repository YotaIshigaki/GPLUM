\subsubsection{Particle Meshクラス}
\label{sec:detail_option_particle_mesh}

この節では、Particle Meshクラスの詳細記述を行う。Particle Meshクラスを
以下のように記述した。

関数{\tt calcForceAllAndWriteBack}はParticle Meshによる力を全粒子に対し
て計算し、その計算結果を書き込むことまで行う。その他の関数が必要となる
のは、複数種類の粒子を扱う場合だけである。

\begin{lstlisting}[caption=ParticleMesh]
namespace ParticleSimulator {
    namespace ParticleMesh {
        class ParticleMesh{
        public:
            template<class Tpsys,
                     class Tdinfo>
            void calcForceAllAndWriteBack(const Tpsys & psys,
                                          const Tdinfo & dinfo);
            template<class Tdinfo>
            void setDomainInfoParticleMesh(const Tdinfo & dinfo);
            template<class Tpsys>
            void setParticleParticleMesh(const Tpsys & psys,
                                         const bool clear=true); 
            void calcMeshForceOnly();
            F32vec getForce(F32vec pos);
        }
    namespace PM = ParticleMesh;
}
namespace PS = ParticleSimulator;
\end{lstlisting}

粒子クラスに粒子質量のゲッターとなるメンバ関数が必要。質量のメンバ変数
が{\tt mass}である場合は、以下のように書く。
\begin{screen}
\begin{verbatim}
void getChargeParticleMesh() {
    return this->mass;
}
\end{verbatim}
\end{screen}

\subsubsubsection{全粒子への力を計算する関数}

\begin{screen}
\begin{verbatim}
template<class Tpsys,
         class Tdinfo>
void PS::PM::calcForceAllAndWriteBack(const Tpsys & psys,
                                      const Tdinfo & dinfo);
\end{verbatim}
\end{screen}

上の関数で、全粒子への力を計算し、計算結果を粒子群クラスへ格納する。
{\tt psys}は力を計算すべき粒子群クラス、{\tt dinfo}は領域クラスである。

計算結果を粒子群クラスへ格納するためのセッターが必要である。粒子クラス
にメンバ関数{\tt copyFromForceParticleMesh(const PS::F32vec \& force)}
を設定する必要がある。もし、Particle Meshによる力のメンバ変数が{\tt
  PS::F32vec apm}であるなら、以下のように記述する。
\begin{screen}
\begin{verbatim}
void copyFromForceParticleMesh(const PS::F32vec & force) {
    this->apm = force;
}
\end{verbatim}
\end{screen}
また、Particle--particleの力(メンバ変数を{\tt acc}とする)にそのまま足し
こむ場合、以下のように記述する。
\begin{screen}
\begin{verbatim}
void copyFromForceParticleMesh(const PS::F32vec & force) {
    this->apc += force;
}
\end{verbatim}
\end{screen}
この関数を使わない場合は、このセッターを用意する必要はない。

この関数は、全プロセスで呼びだす必要がある。

\subsubsubsection{領域クラスをセットする関数}

\begin{screen}
\begin{verbatim}
template<class Tdinfo>
void PS::PM::setDomainInfoParticleMesh(const Tdinfo & dinfo);
\end{verbatim}
\end{screen}

上の関数で、このクラスに領域クラスの情報を与える。引数の{\tt dinfo}は領
域クラスである。

この関数は、全プロセスで呼びだす必要がある。

\subsubsubsection{粒子情報をセットする関数}

\begin{screen}
\begin{verbatim}
template<class Tpsys>
void PS::PM::setParticleParticleMesh(const Tpsys & psys,
                                     const bool clear=true);
\end{verbatim}
\end{screen}

上の関数で、このクラスに粒子群クラスの情報を与える。第１引数の{\tt }は
粒子群クラスである。第２引数はすでに与えられた粒子群クラスの情報をクリ
アするかどうかを決める。{\tt true}のときはクリアし、{\tt false}のときは
クリアしない。

この関数は、全プロセスで呼びだす必要がある。

\subsubsubsection{メッシュ上の力を計算する関数}

\begin{screen}
\begin{verbatim}
void PS::PM::calcMeshForceOnly();
\end{verbatim}
\end{screen}

メッシュ上の力を計算する。

この関数は、全プロセスで呼び出す必要がある。

\subsubsubsection{１つの粒子への力を計算する関数}

\begin{screen}
\begin{verbatim}
PS::F32vec PS::PM::getForce(PS::F32vec pos);
\end{verbatim}
\end{screen}

１つの粒子への力を計算し、その計算結果を返す関数である。引数{\tt pos}は
力を計算したい粒子の位置である。返す値は計算結果の力である。

\subsubsubsection{Particle Meshクラスの使い方}

Particle Meshクラスを使うには以下の４つのことを行う必要がある。
\begin{enumerate}
\item MPIとFFTWのインストール
\item Particle Meshクラスのコンパイル
\item Particle Meshクラスを使ったFDPSコードの記述
\item FDPSコードのコンパイル
\end{enumerate}
以下、詳細に記述する。

\subsubsubsubsection{MPIとFFTWのインストール}

ぐっどらっく

\subsubsubsubsection{Particle Meshクラスのコンパイル}

以下のように行う。ディレクトリ{\tt src\_parallel}の下のディレクトリ
{\tt particle\_mesh}のMakefileを適切に編集してmakeする。編集すべきこと
は以下の２点である。
\begin{itemize}
\item {\tt INCLUDE\_FFTW}にFFTWのヘッダファイルがあるディレクトリを記述
  する
\item param\_fdps.hの中のSIZE\_OF\_MESH (１次元方向のメッシュの数)を設定。
推奨値は $N^{1/3}/2$($N$は粒子数)。
\end{itemize}
うまく行けば、同じディレクトリにライブラリ{\tt libpm.a}とヘッダファイル
{\tt particle\_mesh.hpp}ができている。

\subsubsubsubsection{FDPSコードを記述}

以下のように行う。
\begin{itemize}
\item 上でできたヘッダファイルをincludeする
\item PMを計算したい粒子クラスに以下のメソッドを加える
     \begin{itemize}
     \item void copyFromForceParticleMesh(const PS::F32vec \& force)。こ
     の中でforceを好きなメンバ変数にセットする。
     \item PS::F64 getChargeParticleMesh()。この中で質量を返す。
     \end{itemize}
\item このクラスのインスタンスを生成するときに、{\tt PS::PM::ParticleMesh}と
する
\end{itemize}

\subsubsubsubsection{FDPSコードのコンパイル}

上で記述したFDPSコードをコンパイルするには以下のことを行う必要がある。
\begin{itemize}
\item ヘッダファイル{\tt particle\_mesh.hpp}のあるディレクトリを記述す
  ること
\item ライブラリ{\tt libpm.a}とのリンク
\item FFTWのヘッダファイルがあるディレクトリを記述すること
\item FFTWのライブラリとのリンク
\end{itemize}
