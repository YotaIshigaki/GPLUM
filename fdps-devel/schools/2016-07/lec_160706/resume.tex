\documentclass[12pt,a4paper,dvipdfmx]{jarticle}
%
\topmargin=-5mm
\oddsidemargin=-5mm
\evensidemargin=-5mm
\textheight=235mm
\textwidth=165mm
%
\title{FDPS講習会の手引}
\author{谷川衝、岩澤全規、細野七月、似鳥啓吾、村主崇行、行方大輔、牧野淳一郎}
%\date{\today}
\date{平成26年7月6日}
%\pagestyle{empty}
\usepackage[dvipdfmx]{graphicx}
\usepackage{wrapfig}
\usepackage{lscape}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{setspace}
%\usepackage{listings,jlisting}
\usepackage{color}
\usepackage{ascmac}
\usepackage{here}
\usepackage[dvipdfmx]{hyperref}
\usepackage{pxjahyper}

\newcommand{\underbold}[1]{\underline{\bf #1}}
\newcommand{\redtext}[1]{\textcolor{red}{#1}}

%\setcounter{secnumdepth}{4}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setcounter{secnumdepth}{5}
\makeatletter
\newcommand{\subsubsubsection}{\@startsection{paragraph}{4}{\z@}%
{1.5\baselineskip \@plus.5\dp0 \@minus.2\dp0}%
{.5\baselineskip \@plus2.3\dp0}%
{\reset@font\normalsize\bfseries}
}
\newcommand{\subsubsubsubsection}{\@startsection{subparagraph}{5}{\z@}%
{1.5\baselineskip \@plus.5\dp0 \@minus.2\dp0}%
{.5\baselineskip \@plus2.3\dp0}%
{\reset@font\normalsize\itshape}
}
\makeatother
\setcounter{tocdepth}{5}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\maketitle
\tableofcontents

\newpage

\section{プログラム}

\begin{itemize}

\item 13:00 -- 14:00 FDPSの講義
  \begin{itemize}
  \item 13:00 -- 13:05 イントロダクション (牧野淳一郎)
  \item 13:05 -- 13:15 概要説明 (行方大輔)
  \item 13:15 -- 13:25 FDPSで必要なC++解説 (似鳥啓吾)
  \item 13:25 -- 13:35 FDPS詳細1 -- APIと内部構造 (岩澤全規)
  \item 13:35 -- 13:45 FDPS詳細2 -- サンプルコード解説 (細野七月)
  \item 13:45 -- 14:00 Q\&A
  \end{itemize}

\item 14:00 -- 15:30 FDPSの実習
  \begin{itemize}
  \item FDPSのインストール
  \item サンプルコードの使用1 (重力N体シミュレーションコード)
  \item サンプルコードの使用2 (SPHシミュレーションコード)
  \end{itemize}

\item 15:30 -- 17:00 FDPS使用に関する相談

\end{itemize}

\newpage

\section{FDPSの実習}

\subsection{準備}

\subsubsection{FOCUSの計算機を用いる場合}
まずは、FOCUSの計算機にログインするまでの手順を紹介する。講習用PCの電
源をつけたら、講習会当日に受けとったアカウント名とパスワードを使ってロ
グインする。PCが起動したらデスクトップ上のXwin Severをダブルクリックし、
X serverを立ち上げる(図\ref{fig:x11appear}参照)。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/x11appear_.png}
  \end{center}
  \caption{}
  \label{fig:x11appear}
\end{figure}

次にVPN接続を行う為、デスクトップ上にあるCisco AnyConect Secure
Mobility Client をダブルクリックで起動する(図\ref{fig:x11appear}参照)。
すると図\ref{fig:cisco}の様な画面が現れるので、Connectをクリック。ユー
ザー名、パスワードを聞かれるので、事前に配布されたユーザー名、パスワー
ドを入力する(図\ref{fig:cisco_connect}参照)。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/cisco_.png}
  \end{center}
  \caption{}
  \label{fig:cisco}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/cisco_connect_.png}
  \end{center}
  \caption{}
  \label{fig:cisco_connect}
\end{figure}

次にデスクトップ上にあるTera Termをダブルクリックして起動する(図
\ref{fig:x11appear}参照)。すると図\ref{fig:teraterm1}の様な画面が現れ
るので、一度キャンセルする。上のタブの設定(図\ref{fig:teraterm2}参照)
からSSH転送をクリックすると図\ref{fig:teraterm3}の様な画面が現れるので、
リモートのアプリケーションをローカルのXサーバーに表示するのチェックを
入れる。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm1_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm1}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm2_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm2}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm3_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm3}
\end{figure}

上のタブのファイルから新しい接続を選び(図\ref{fig:teraterm4}参照)、図
\ref{fig:teraterm5}の画面になるので、ホスト名をffにしてOKを押す。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm4_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm4}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm5_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm5}
\end{figure}

図\ref{fig:teraterm6}の画面になったら、続行を押し、図
\ref{fig:teraterm7}の画面になるので、事前に配布されたユーザー名、パス
ワードを入力する。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm6_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm6}
\end{figure}

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm7_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm7}
\end{figure}


図\ref{fig:teraterm8}の画面になればFOCUSの計算機にログイン成功である。

\begin{figure}
  \begin{center}
    \includegraphics[clip, width=10.0cm]{./fig/teraterm8_.png}
  \end{center}
  \caption{}
  \label{fig:teraterm8}
\end{figure}

FOCUSの計算機にログインしたら、以下のコマンドを実行する。
\begin{screen}
\begin{verbatim}
$ module load gnu/openmpi165
\end{verbatim}
\end{screen}

以下のコマンドを実行し、FDPSを自分のカレントディレクトリにコピーする
(「\verb|$|」はコマンドプロンプトであるので、「\verb|$|」を打ち込む必
要はない)。
\begin{screen}
\begin{verbatim}
$ cp -r ../share/FDPS2.0 .
\end{verbatim}
\end{screen}
以上により、ディレクトリ\texttt{FDPS2.0}がコピーされる。以下ではディレ
クトリ\texttt{FDPS2.0}があるディレクトリの名前を\texttt{fdps}とする。

\subsubsection{自分で用意した計算機で実行する場合}
\texttt{https://github.com/FDPS/FDPS}からFDPSの最新版をダウンロードし、
好きなディレクトリ下で解凍する。これによってディレクトリ
\texttt{FDPS-master}が出来る。以下ではディレクトリ\texttt{FDPS-master}
があるディレクトリの名前を\texttt{fdps}とし、文章中の\texttt{FDPS2.0}
を\texttt{FDPS-master}と読み替える。

\subsection{実習本番}

実習で行うことは、FDPSを使って実装された重力$N$体シミュレーションコー
ドとSPHシミュレーションコードを使用することである。最初に重力$N$体シミュ
レーションコード、次にSPHシミュレーションコードを使用する。

なお、実習の際に\texttt{Makefile}を更新し、コンパイルし直すという作業
を何回か行うが、ここで注意しなくてはならないのは、
\textbf{\texttt{Makefile}を編集しただけでは実行ファイルの再作成は行わ
  れない}ということである。この場合、きちんと前回作った実行ファイルを
明示的に``\texttt{\$ rm ./nbody.out}''もしくは``\texttt{\$ make
  clean}''などで消す必要がある。これを忘れた場合、「\texttt{make:
    `nbody.out'} は更新済みです」と出る。

\subsubsection{重力$N$体シミュレーションコード}
ここでは、重力$N$体シミュレーションコードでのcold collapseを、並列環境
無し、OpenMPを用いた並列計算環境、OpenMP + MPIを用いた並列計算環境の3
つで行う。後者の2つに関してはFOCUSスパコンに計算を用いる。

%\color{red}
%そのためにはこういう事をします云々。。。
%\color{black}

\subsubsubsection{概要}

ここでは、用意された重力$N$体シミュレーションコードを動かしてみよう。こ
のコードは、重力多体系のコールドコラプスを計算する。この節でまず行うこ
とは、シリアルコードのコンパイルと実行、出て来た結果の解析である。次に
シリアルコードをPhantom-GRAPEを用いて高速化して、その速さを体験しよう。
最後にOpenMPやMPI を利用して、さらにコードを高速化する。

\subsubsubsection{シリアルコード}

以下の手順で本コードを使用できる。
\begin{itemize}
\item ディレクトリ\texttt{fdps/FDPS2.0/sample/nbody}に移動
\item \texttt{make}を実行
\item ジョブの投入
\item 結果の解析
\item OpenMP/MPIの利用(オプション)
\end{itemize}

\subsubsubsubsection{ディレクトリ移動}

ディレクトリ\texttt{fdps/FDPS2.0/sample/nbody}に移動する。
\begin{screen}
\begin{verbatim}
$ cd fdps/FDPS2.0/sample/nbody
\end{verbatim}
\end{screen}

\subsubsubsubsection{makeの実行}
\texttt{make}コマンドを実行する。
\begin{screen}
\begin{verbatim}
$ make
\end{verbatim}
\end{screen}

\subsubsubsubsection{計算の実行}

まずは、インタラクティブ実行で計算を実行する。これは、生成された実行ファ
イルの名前をそのまま実行すればよい。
\begin{screen}
\begin{verbatim}
$ ./nbody.out
\end{verbatim}
\end{screen}

計算が開始されると以下の様な表示が出力される。
\begin{screen}
\begin{verbatim}
     //==================================\\
     ||                                  ||
     || ::::::: ::::::. ::::::. .::::::. ||
     || ::      ::    : ::    : ::       ||
     || ::::::  ::    : ::::::'  `:::::. ||
     || ::      ::::::' ::      `......' ||
     ||     Framework for Developing     ||
     ||        Particle Simulator        ||
     ||     Version 2.0 (2016/06)        ||
     \\==================================//

       Home   : https://github.com/fdps/fdps
       E-mail : fdps-support@mail.jmlab.jp
       Licence: MIT (see, https://github.com/FDPS/FDPS/blob/master/LICENSE)
       Note   : Please cite Iwasawa et al. (in press.)

       Copyright (C) 2015
         Masaki Iwasawa, Ataru Tanikawa, Natsuki Hosono,
         Keigo Nitadori, Takayuki Muranushi, Daisuke Namekata
         Junichiro Makino and many others
******** FDPS has successfully begun. ********
./result/t-de.dat
Number of processes: 1
Number of threads per process: 1
(以下省略)
\end{verbatim}
\end{screen}


正しくジョブが終了すると、標準入出力の最後には以下のようなログが出力さ
れるはずである。energy errorは絶対値で$1 \times 10^{-3}$のオーダーに収
まっていればよい。
\begin{screen}
\begin{verbatim}
time:  9.5000000 energy error: -3.804653e-03
time:  9.6250000 energy error: -3.971175e-03
time:  9.7500000 energy error: -3.822343e-03
time:  9.8750000 energy error: -3.884310e-03
******** FDPS has successfully finished. ********
\end{verbatim}
\end{screen}
ただし、後述するPhantom-GRAPEを用いた場合、energy error数値は変わるので注意する。

\subsubsubsubsection{結果の解析}

ディレクトリ\texttt{result}に粒子分布を出力したファイル"000*.dat"ができ
ている。*は0から9の値で、時刻を表す。出力ファイルフォーマットは1列目か
ら順に粒子のID, 粒子の質量、位置の$x$, $y$, $z$座標、粒子の$x$, $y$,
$z$軸方向の速度である。

ここで実行したのは、粒子数1024個からなる一様球(半径3)のコールドコラプス
である。コマンドライン上で以下のコマンドを実行すれば、時刻9における
$xy$平面に射影した粒子分布を見ることができる。
\begin{screen}
\begin{verbatim}
$ gnuplot
$ set size square
$ plot [-5:5][-5:5]"result/0009.dat" using 3:4
\end{verbatim}
\end{screen}

他の時刻の粒子分布をプロットすると、一様球が次第に収縮し、その後もう一
度膨張する様子を見ることができる(図\ref{fig:nbody}参照)。

\begin{figure}
  \begin{center}
        \includegraphics[width=10cm,bb=0 0 220 220]{fig/nbody.eps}
  \end{center}
  \caption{}
  \label{fig:nbody}
\end{figure}

\subsubsubsection{Phantom-GRAPEの利用}

以下では、相互作用計算にPhantom-GRAPEを使う場合について、記述する。この
場合、ユーザーはまずはPhantom-GRAPEのコンパイルを行わなければならない。
今回使うPhantom-GRAPEのソースコードは、
\texttt{fdps/FDPS2.0/src/phantom\_grape\_x86/G5/newton/libpg5/} 以
下に存在するので、そこまで移動し、コンパイルを行う。以下は、現在
\texttt{sample/nbody/}に居る場合の例である。
\begin{screen}
\begin{verbatim}
$ cd ../../src/phantom_grape_x86/G5/newton/libpg5/
$ make
\end{verbatim}
\end{screen}

コンパイルが成功したら、元のディレクトリに戻る。次に、
\texttt{Makefile}の修正を行う。\texttt{Makefile}の
\begin{screen}
\begin{verbatim}
#use_phantom_grape_x86 = yes
\end{verbatim}
\end{screen}
となっているところのコメントアウトを外しコンパイルを行う。

無事にコンパイルが通れば、以降の実行・解析の手順は同様である。実行直後
の表示に''rsqrt: MSE = ...''という行が追加されていれば正しく実行ができ
ている。
\begin{screen}
\begin{verbatim}
(省略)
******** FDPS has successfully begun. ********
./result/t-de.dat
Number of processes: 1
Number of threads per process: 1
rsqrt: MSE = 1.158186e-04,  Bias = 8.375360e-08
(省略)
\end{verbatim}
\end{screen}

\subsubsubsection{OpenMP/MPIの利用}

OpenMPやMPIを利用する場合について以下に記述する。

以降では、計算の実行の際にはジョブの投入を行うことにする。以下の様なコ
マンドでジョブの投入を行う。これはOpenMP実行の際の例である。
\begin{screen}
\begin{verbatim}
$ sbatch runOMP.sh
\end{verbatim}
\end{screen}
正しくジョブが投入されている場合、\texttt{squeue}コマンドを実行すると、例えば以
下のようにログが出力される。
\begin{screen}
\begin{verbatim}
 JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
200402     d006h    nbody uleo0016 PD       0:00      1 (None)
\end{verbatim}
\end{screen}
ジョブのキャンセルは以下のコマンドで実行できる。
\begin{screen}
\begin{verbatim}
$ scancel JOBID
\end{verbatim}
\end{screen}
JOBIDは上の\texttt{squeue}コマンドで表示されたJOBIDの番号である(上で言
えば、200402)。正しくジョブが終了すると、ファイル\texttt{stdout.log}の
最後にログが出力される。


\begin{itemize}
\item OpenMPのみ使用の場合
  \begin{itemize}
  \item \texttt{Makefile}の編集
    \begin{itemize}
    \item マクロ\texttt{CC}にOpenMP対応のC++コンパイラを代入する。
          今回の実習の環境では変更する必要は無い。
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_THREAD\_PARALLEL}''と``\texttt{CFLAGS += -fopenmp}''の
      2行のコメントアウトを外す（インテルコンパイラの場合は\texttt{-fopenmp}のコメントアウトははずさない）。
    \end{itemize}
  \item \texttt{make}コマンドを実行する。
  \item \texttt{sbatch runOMP.sh}と打って実行する。正しく実行された場合、stdout.logに以下のように表示されるはずである。
\begin{screen}
\begin{verbatim}
This is a sample program of N-body simulation on FDPS!
Number of processes: 1
Number of threads per process: 4
time:  0.0000000 energy error: -0.000000e+00
(省略)
\end{verbatim}
\end{screen}
       見て分かる通り、\texttt{Number of threads per process: 4}となっている。
       これで、4スレッドでの並列計算が行われている事が確認できた。
  \end{itemize}

\item OpenMPとMPIの同時使用の場合
  \begin{itemize}
  \item \texttt{Makefile}の編集
    \begin{itemize}
    \item マクロ\texttt{CC}にMPI対応のC++コンパイラを代入する。
      今回の実習の環境では\texttt{mpiCC}にする。
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_THREAD\_PARALLEL}''と``\texttt{CFLAGS += -fopenmp}''の
      2行のコメントアウトを外す（インテルコンパイラの場合は\texttt{-fopenmp}のコメントアウトははずさない）。      
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_MPI\_PARALLEL}''の行のコメント
      アウトを外す
    \end{itemize}
  \item \texttt{make}コマンドを実行する。
  \item \texttt{sbatch runMPI.sh}と打って実行する。正しく実行された場合、stdout.logに以下のように表示されるはずである。
\begin{screen}
\begin{verbatim}
This is a sample program of N-body simulation on FDPS!
Number of processes: 2
Number of threads per process: 4
time:  0.0000000 energy error: -0.000000e+00
(省略)
\end{verbatim}
\end{screen}
       \texttt{Number of processes: 2}となっている事がわかる。これで、
       2プロセス4スレッドでの並列計算が行われている事が確認できた。
  \end{itemize}
\end{itemize}



\subsubsection{SPHシミュレーションコード}

\subsubsubsection{概要}

ここでは、SPHシミュレーションコードを動かす。用意されているコードは、断
熱スフィアコラプスの計算を行う。この節でまず行うことは、シリアルコード
のコンパイルと実行、出て来た結果の解析である。最後にOpenMPやMPI を利用
して、さらにコードを高速化する。

\subsubsubsection{シリアルコード}

以下の手順で本コードを使用できる。
\begin{itemize}
\item ディレクトリ\texttt{fdps/FDPS2.0/sample/nbodysph}に移動
\item \texttt{make}を実行
\item ジョブの投入
\item 結果の解析
\item OpenMP/MPIの利用(オプション)
\end{itemize}

\subsubsubsubsection{ディレクトリ移動}

ディレクトリ\texttt{fdps/FDPS2.0/sample/nbodysph}に移動に移動する。

\subsubsubsubsection{makeの実行}

\texttt{make}コマンドを実行する。

\subsubsubsubsection{計算の実行}
まずは、インタラクティブ実行で計算を実行する。
これは、生成された実行ファイルの名前をそのまま実行すればよい。
\begin{screen}
\begin{verbatim}
$ ./sph.out
\end{verbatim}
\end{screen}

正しくジョブが終了すると、最後に以下のようなログが出力されるはずである。
\begin{screen}
\begin{verbatim}
(省略)
//================================
time = 7.6861124696015781e-01, dt = 3.5727841270539857e-03
step = 88
//================================
9.9999999999997635e-01
6.6872858041836647e-01
9.7700092080239072e-04
9.7700092080317243e-04
9.7700092080318761e-04
******** FDPS has successfully finished. ********
\end{verbatim}
\end{screen}

\subsubsubsubsection{結果の解析}

ディレクトリ\texttt{result}にファイルが出力されている。ファイル名は"00**.dat"(*
には数字が入る)となっている。ファイル名は時刻を表す。出力ファイルフォー
マットは1列目から順に粒子のID、粒子の質量、位置の$x$, $y$, $z$ 座標、粒子の
$x$, $y$, $z$軸方向の速度、密度、内部エネルギー、圧力である。

これは３次元のEvrard sphereである。以下のコマンドを実行すれば、横軸に
$r$、縦軸に密度のlogscaleでの図が作成される。

\begin{screen}
\begin{verbatim}
$ gnuplot
$ set logscale
$ plot "result/0040.dat" using (sqrt($3**2 + $4**2 + $5**2)):9
\end{verbatim}
\end{screen}
正しい答が得られれば、図\ref{fig:sph}のような図を描ける。

\begin{figure}
  \begin{center}
    \includegraphics[width=10cm,bb=0 0 608 444]{fig/sph.png}
  \end{center}
  \caption{}
  \label{fig:sph}
\end{figure}

\subsubsubsection{OpenMP/MPIの利用}

OpenMPやMPIを利用する場合を以下に示す。
\begin{itemize}
\item OpenMPのみ使用の場合
  \begin{itemize}
  \item \texttt{Makefile}の編集
    \begin{itemize}
    \item マクロ\texttt{CC}にOpenMP対応のC++コンパイラを代入する
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_THREAD\_PARALLEL}''と``\texttt{CFLAGS += -fopenmp}''の
      2行のコメントアウトを外す（インテルコンパイラの場合は\texttt{-fopenmp}のコメントアウトははずさない）。
    \end{itemize}
  \item \texttt{make}コマンドを実行する。
  \item \texttt{sbatch runOMP.sh}と打って実行する。正しく実行された場合、stdout.log以下のように表示されるはずである。
\begin{screen}
\begin{verbatim}
This is a sample program of Smoothed Particle Hydrodynamics on FDPS!
# of proc is   1
# of thread is 4
//=====================================
setup...
time = 0.0000000000000000e+00, dt = 8.5419983049046022e-02
//================================
(省略)
\end{verbatim}
\end{screen}
  \end{itemize}

\item OpenMPとMPIの同時使用の場合
  \begin{itemize}
  \item \texttt{Makefile}の編集
    \begin{itemize}
    \item マクロ\texttt{CC}にMPI対応のC++コンパイラを代入する
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_THREAD\_PARALLEL}''と``\texttt{CFLAGS += -fopenmp}''の
      2行のコメントアウトを外す（インテルコンパイラの場合は\texttt{-fopenmp}のコメントアウトははずさない）。
    \item ``\texttt{CFLAGS += -DPARTICLE\_SIMULATOR\_MPI\_PARALLEL}''の行のコメント
      アウトを外す
    \end{itemize}
  \item \texttt{make}コマンドを実行する。
  \item \texttt{sbatch runMPI.sh}と打って実行する。正しく実行された場合、stdout.log以下のように表示されるはずである。
\begin{screen}
\begin{verbatim}
This is a sample program of Smoothed Particle Hydrodynamics on FDPS!
# of proc is   2
# of thread is 4
//=====================================
setup...
time = 0.0000000000000000e+00, dt = 8.5419983049046022e-02
time = 0.0000000000000000e+00, dt = 8.5419983049046022e-02
//================================
(省略)
\end{verbatim}
\end{screen}
  \end{itemize}
\end{itemize}

\end{document}
