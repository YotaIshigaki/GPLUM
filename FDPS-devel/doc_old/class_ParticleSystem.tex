
\subsubsection{概要}

{\tt FullParticle}の配列を持ち、粒子の交換等を行うクラス。粒子の読み込
みや書き込み等はこのクラスを通して行う。粒子種の数だけインスタンスを作
る必要がある。

粒子群クラス({\tt PS::ParticleSystem})は以下のように記述される。

\begin{lstlisting}[caption=粒子群クラス]
namespace ParticleSimulator{
    template<class Tptcl>
    class ParticleSystem{
    public:

        template <class Theader>
        void readParticleAscii(const char * const filename,
                               const char * const format,
                               const Theader& header);
        template <class Theader>
        void readParticleAscii(const char * const filename,
                               const Theader& header);
        void readParticleAscii(const char * const filename,
                               const char * const format);
        void readParticleAscii(const char * const filename);

        template <class Theader>
        void writeParticleAscii(const char * const filename,
                                const char * const format,
                                Theader& header);
        template <class Theader>
        void writeParticleAscii(const char * const filename,
                                Theader& header);
        void writeParticleAscii(const char * const filename,
                                const char * const format);
        void writeParticleAscii(const char * const filename);


        void createParticleArray(const S32 array_size);

        template<class Tdinfo>
        void exchangeParticle(const Tdinfo & dinfo);
        Tptcl & operator [] (const S32 id);
        const Tptcl & operator [] (const S32 id) const;
        Tptcl * getParticlePointer(const S32 id=0);
        S32 getNumberOfParticleLocal() const;
        S64 getNumberOfParticleTotal() const;
        S32 getSizeOfParticle() const;
    };
}
\end{lstlisting}

\subsubsection{API}

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% format
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%  \begin{screen}
%%%  \begin{verbatim}
%%%  function()
%%%  \end{verbatim}
%%%  \end{screen}
%%%
%%%  \begin{itemize}
%%%
%%%  \item{{\bf 引数}}
%%%
%%%  \item{{\bf 返り値}}
%%%
%%%  \item{{\bf 機能}}
%%%
%%%  \end{itemize}
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{ファイル入出力}
\mbox{}
%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
template <class Theader>
void PS::ParticleSystem::readParticleAscii(const char * const filename,
                                           const char * const format,
                                           Theader& header);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char *}型。入力ファイル名のベースとなる部分。

{\tt format}: 入力。{\tt const char *}型。分散ファイルから粒子データを読み込む際のファイルフォーマット。

{\tt header}: 入力。{\tt Theader\&}型。ファイルのヘッダ情報。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}と{\tt format}で指定された入力ファイルから粒子データを読み出し、データを{\tt FullParticle}として格納する。

{\tt filename}で、分散しているファイルのベースとなる名前を指定する。
{\tt format}でファイル名のフォーマットを指定する。
フォーマットの指定方法は標準Cライブラリの関数\verb|printf|の第1引数と同じである。
ただし変換指定は必ず3つであり、その指定子は1つめは文字列、残りはどちらも整数である。
2つ目の変換指定にはそのジョブの全プロセス数が、3つ目の変換指定にはプロセス番号が入る。
例えば、{\tt filename}が\verb|nbody|、{\tt format}が\verb|%s_%03d_%03d.init|ならば、全プロセス数$64$のジョブのプロセス番号$12$のプロセスは、\verb|nbody_064_012.init|というファイルを読み込む。

1粒子のデータを読み取る関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
名前は{\tt readAscii}であり、引数は{\tt FILE*}型である。
例えば3次元の重力計算の場合、以下のように定義できる。
読み込むべき1粒子のデータは、質量(\verb|PS::F64 mass|)、位置(\verb|PS::F64vec pos|)、速度(\verb|PS::F64vec vel|)であり、そのフォーマットが10進数アスキーであるとする。

\begin{verbatim}
void FullParticle::readAscii(FILE *fp){
    fscanf(fp, "%lf%lf%lf%lf%lf%lf%lf",
                  &this->mass,
                  &this->pos[0], &this->pos[1], &this->pos[2],
                  &this->vel[0], &this->vel[1], &this->vel[2]);
    return;
}
\end{verbatim}

ユーザがこの関数を定義するに当って、以下の制限がある。
\begin{itemize}
\item 返値の型が\verb|void|。
\item 引数にファイルポインタを取り、このファイルポインタを入力先に指定すること
\end{itemize}

ファイルのヘッダのデータを読み取る関数は{\tt Theader}のメンバ関数でユーザが定義する。
名前は{\tt readAscii}であり、引数は{\tt FILE*}型である。
もし、ヘッダーに粒子数が含まれていれば、この関数は粒子数を返さなければならない。
この時、返ってきた粒子数分、ファイルから粒子データを読み込む。
ヘッダーに粒子数が含まれていない場合は-1以下の整数を返さなければならない。
この時、１回ファイルを読み込んで行数を取得した後、もう一度ファイルを読み込みなおし、粒子データを読み込む。
例えばヘッダーに粒子数(\verb|nbody|)、時刻(\verb|time|)が入っている場合、以下の様になる。

\begin{verbatim}
S32 Theader::readAscii(FILE *fp) {
    fscanf(fp, "%d%lf", &nbody, &time);
    return nbody;
}
\end{verbatim}

ユーザがこの関数を定義するに当って、以下の制限がある。
\begin{itemize}
\item 返値の型が\verb|PS::S32|。
\item 引数にファイルポインタを取り、このファイルポインタを入力先に指定すること
\end{itemize}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
void PS::ParticleSystem::readParticleAscii(const char * const filename,
                                           const char * const format);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。入力ファイル名のベースとなる部分。

{\tt format}: 入力。{\tt const char * const}型。分散ファイルから粒子データを読み込む際のファイルフォーマット。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}と{\tt format}で指定された入力ファイルから粒子データを読み出し、データを{\tt FullParticle}として格納する。
この時、１回ファイルを読み込んで行数を取得した後、もう一度ファイルを読み込みなおし、粒子データを読み込む。

{\tt filename}で、分散しているファイルのベースとなる名前を指定する。
{\tt format}でファイル名のフォーマットを指定する。
{\tt format}の指定の仕方は、{\tt Theader}が存在する場合の時と同様である。

1粒子のデータを読み取る関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
このメンバ関数の書式と規約は、分散ファイルから読み出す場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
template <class Theader>
void PS::ParticleSystem::readParticleAscii(const char * const filename,
                                           Theader& header);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。入力ファイル名。

{\tt header}: 入力。{\tt Theader\&}型。ファイルのヘッダ情報。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

ルートプロセスが{\tt filename}で指定された入力ファイルから粒子データを読み出し、データを{\tt FullParticle}として格納した後、各プロセスに分配する。

1粒子のデータを読み取る関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
ファイルのヘッダのデータを読み取る関数は{\tt Theader}のメンバ関数でユーザが定義する。
これら2つのメンバ関数の書式と規約は、分散ファイルから読み出す場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
void PS::ParticleSystem::readParticleAscii(const char * const filename);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。入力ファイル名。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

ルートプロセスが{\tt filename}で指定された入力ファイルから粒子データを読み出し、データを{\tt FullParticle}として格納した後、各プロセスに分配する。
この時、１回ファイルを読み込んで行数を取得した後、もう一度ファイルを読み込みなおし、粒子データを読み込む。

1粒子のデータを読み取る関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
このメンバ関数の書式と規約は、分散ファイルから読み出す場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
template <class Theader>
void PS::ParticleSystem::void writeParticleAscii(const char * const filename,
                                                 const char * const format,
                                                 const Theader& header);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。出力ファイル名のベースとなる部分。

{\tt format}: 入力。{\tt const char * const}型。分散ファイルに粒子データを書き込む際のファイルフォーマット。

{\tt header}: 入力。{\tt const Theader\&}型。ファイルのヘッダ情報。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}と{\tt format}で指定された出力ファイルに{\tt FullParticle}型の粒子データと、{\tt Theader}型のヘッダー情報を出力する。
出力ファイルのフォーマットはメンバ関数\verb|PS::ParticleSystem::readParticleAscii|と同様である。

1粒子のデータを書き込む関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
名前は{\tt writeAscii}であり、引数は{\tt FILE*}型である。
例えば重力計算の場合、以下のように定義できる。
読み込むべき1粒子のデータは、質量(\verb|PS::F64 mass|)、位置(\verb|PS::F64vec pos|)、速度(\verb|PS::F64vec vel|)であり、そのフォーマットが10進数アスキーであるとする。

\begin{verbatim}
void FullParticle::writeAscii(FILE *fp) const{
    fprintf(fp, "%lf%lf%lf%lf%lf%lf%lf",
                this->mass,
                this->pos[0], this->pos[1], this->pos[2],
                this->vel[0], this->vel[1], this->vel[2]);
}
\end{verbatim}

ユーザがこの関数を定義するに当って、以下の制限がある。
\begin{itemize}
\item 返値の型が\verb|void|。
\item 引数にファイルポインタを取り、このファイルポインタを入力先に指定すること。
\item \verb|const|メンバ関数であること。
\end{itemize}

ファイルのヘッダのデータを書き込む関数は{\tt Theader}のメンバ関数でユーザが定義する。
名前は{\tt writeAscii}であり、引数は{\tt FILE*}型である。
例えばヘッダーに粒子数(\verb|nbody|)、時刻(\verb|time|)が入っている場合、以下の様になる。

\begin{verbatim}
void Theader::writeAscii(FILE *fp) const{
     fprintf(fp, "%d%lf", nbody, time);
}
\end{verbatim}

ユーザがこの関数を定義するに当って、以下の制限がある。
\begin{itemize}
\item 返値の型が\verb|void|。
\item 引数にファイルポインタを取り、このファイルポインタを入力先に指定すること。
\item \verb|const|メンバ関数であること。
\end{itemize}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
void PS::ParticleSystem::void writeParticleAscii(const char * const filename,
                                                 const char * const format);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。出力ファイル名のベースとなる部分。

{\tt format}: 入力。{\tt const char * const}型。分散ファイルに粒子データを書き込む際のファイルフォーマット。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}と{\tt format}で指定された出力ファイルに{\tt FullParticle}型の粒子データを出力する。
出力ファイルのフォーマットはメンバ関数\verb|PS::ParticleSystem::readParticleAscii|と同様である。

1粒子のデータを書き込む関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
このメンバ関数の書式と規約は、分散ファイルに書き込む場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
template <class Theader>
void PS::ParticleSystem::void writeParticleAscii(const char * const filename,
                                                 const Theader& header);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。出力ファイル名。

{\tt header}: 入力。{\tt const Theader\&}型。ファイルのヘッダ情報。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}で指定された出力ファイルに{\tt FullParticle}型の粒子データと、{\tt Theader}型のヘッダー情報を出力する。

1粒子のデータを書き込む関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
ファイルのヘッダのデータを書き込む関数は{\tt Theader}のメンバ関数でユーザが定義する。
これら2つのメンバ関数の書式と規約は、分散ファイルに書き込む場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{screen}
\begin{verbatim}
void PS::ParticleSystem::void writeParticleAscii(const char * const filename);
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt filename}: 入力。{\tt const char * const}型。出力ファイル名。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

各プロセスが{\tt filename}で指定された出力ファイルに{\tt FullParticle}型の粒子データを出力する。

1粒子のデータを書き込む関数は{\tt FullParticle}のメンバ関数でユーザが定義する。
このメンバ関数の書式と規約は、分散ファイルに書き込む場合と同様である。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{粒子交換}
\mbox{}
%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
void PS::ParticleSystem::exchangeParticle(const PS::DomainInfo & dinfo)
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt dinfo}: 入力。{\tt const PS::DomainInfo \&}型。

\item{{\bf 返り値}}

なし。

\item{{\bf 機能}}

粒子が適切なドメインに配置されるように、粒子の交換を行う。どのドメイン
にも属さない粒子が現れた場合、例外を送出する。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{その他}
\mbox{}
%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
FullPtcl & PS::ParticleSystem::operator [] (const PS::S32 id)
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt id}: {\tt const PS::S32}型。

\item{{\bf 返り値}}

{\tt FullPtcl \&}型。{\tt id}番目の粒子の参照を返す。

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
FullPtcl * PS::ParticleSystem::getParticlePointer(const PS::S32 id)
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

{\tt id}: 入力。{\tt const PS::S32}型。

\item{{\bf 返り値}}

{\tt FullPtcl *}型。id番目の粒子へのポインタを返す。


\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
PS::S32 PS::ParticleSystem::getNumberOfParticleLocal()
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

なし。

\item{{\bf 返り値}}

{\tt PS::S32}型。自身が担当する粒子数を返す。

\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
PS::S64 PS::ParticleSystem::getNumberOfParticleGlobal()
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

なし。

\item{{\bf 返り値}}

{\tt PS::S64}型。全プロセスでの粒子の総数を返す。

\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{screen}
\begin{verbatim}
PS::S32 PS::ParticleSystem::getSizeOfParticle()
\end{verbatim}
\end{screen}

\begin{itemize}

\item{{\bf 引数}}

なし。

\item{{\bf 返り値}}

{\tt PS::S32}型。自身が持つ粒子配列のサイズを返す。

\end{itemize}


