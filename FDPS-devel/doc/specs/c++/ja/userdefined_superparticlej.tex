\subsubsection{概要}SuperParticleJクラスは近い粒子同士でまとまった複数の粒子を代表してまとめた超粒子の情報を持つクラスであり、相互作用の定義(節\ref{sec:overview_action}の手順0)に必要となる。このクラスが必要となるのはPS::SEARCH\_MODEに以下のいずれかを選択した場合だけである。
\begin{itemize}%[itemsep=-1ex]
\item PS::SEARCH\_MODE\_LONG
\item PS::SEARCH\_MODE\_LONG\_SCATTER
\item PS::SEARCH\_MODE\_LONG\_SYMMETRY\item PS::SEARCH\_MODE\_LONG\_CUTOFF
\end{itemize}
このクラスのメンバ関数には、超粒子の位置情報をFDPS側とやりとりする
メンバ関数がある。また、超粒子の情報とMomentクラスの情報は対になる
ものである。従って、このクラスのメンバ関数には、Momentクラスから
このクラスへ情報を変換(またはその逆変換)するメンバ関数がある。SuperParticleJクラスもMomentクラス同様、ある程度決っているものが多いので、それらについてはFDPS側で用意した。以下、既存のクラス、SuperParticleJクラスを作るときに必要なメンバ関数、場合によっては必要なメンバ関数について記述する。\subsubsection{既存のクラス}FDPSはいくつかのSuperParticleJクラスを用意している。以下、各PS::SEARCH\_MODEに対し選ぶことのできるクラスについて記述する。PS::SEARCH\_MODE\_LONG、PS::SEARCH\_MODE\_LONG\_SCATTER、
PS::SEARCH\_MODE\_LONG\_SYMMETRY、PS::SEARCH\_MODE\_LONG\_CUTOFF
の場合をこの順序で記述する。その他の\\PS::SEARCH\_MODEでは超粒子を必要としない。\subsubsubsection{PS::SEARCH\_MODE\_LONG}\subsubsubsubsection{PS::SPJMonopole}
\label{sec:SPJMonopole}単極子までの情報を持つMomentクラスPS::MomentMonopoleと対になるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJMonopole {    public:        F64    mass;        F64vec pos;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJMonopole\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心\item 使用条件  MomentクラスであるPS::MomentMonopoleクラスの使用条件に準ずる。\end{itemize}\subsubsubsubsection{PS::SPJQuadrupole}
\label{sec:SPJQuadrupole}単極子と四重極子を情報を持つMomentクラスPS::MomentQuadrupoleと対になるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJQuadrupole {    public:        F64    mass;        F64vec pos;        F64mat quad;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJQuadrupole\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心  quad: 近傍でまとめた粒子の四重極子\item 使用条件  MomentクラスであるPS::MomentQuadrupoleクラスの使用条件に準ずる。\end{itemize}\subsubsubsubsection{PS::SPJMonopoleGeometricCenter}
\label{sec:SPJMonopoleGeometricCenter}
単極子までを情報として持つ(ただしモーメント計算の際の座標系の中心は粒子の幾何中心)MomentクラスPS::MomentMonopoleGeometricCenterと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJMonopoleGeometricCenter {    public:        F64    charge;            F64vec pos;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJMonopoleGeometricCenter\item メンバ変数とその情報  charge: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の幾何中心\item 使用条件  PS::MomentMonopoleGeometricCenterの使用条件に準ずる。\end{itemize}\subsubsubsubsection{PS::SPJDipoleGeometricCenter}
\label{sec:SPJDipoleGeometricCenter}
双極子までを情報として持つ(ただしモーメント計算の際の座標系の中心は粒子の幾何中心)MomentクラスPS::MomentDipoleGeometricCenterと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJDipoleGeometricCenter {    public:        F64    charge;            F64vec pos;        F64vec dipole;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJDipoleGeometricCenter\item メンバ変数とその情報  charge: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の幾何中心  dipole: 粒子の質量または電荷の双極子\item 使用条件  PS::MomentDipoleGeometricCenterの使用条件に準ずる。\end{itemize}\subsubsubsubsection{PS::SPJQuadrupoleGeometricCenter}
\label{sec:SPJQuadrupoleGeometricCenter}四重極子までを情報として持つ(ただしモーメント計算の際の座標系の中心は粒子の幾何中心)MomentクラスPS::MomentQuadrupoleGeometricCenterと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJQuadrupoleGeometricCenter {    public:        F64    charge;            F64vec pos;        F64vec dipole;        F64mat quadrupole;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJQuadrupoleGeometricCenter\item メンバ変数とその情報  charge: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の幾何中心  dipole: 粒子の質量または電荷の双極子  quadrupole: 粒子の質量または電荷の四重極子\item 使用条件  PS::MomentQuadrupoleGeometricCenterの使用条件に準ずる。\end{itemize}
  
\subsubsubsection{PS::SEARCH\_MODE\_LONG\_SCATTER}\subsubsubsubsection{PS::SPJMonopoleScatter}
\label{sec:SPJMonopoleScatter}単極子までを情報として持つMomentクラスPS::MomentMonopoleScatterと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJMonopoleScatter {    public:        F64    mass;        F64vec pos;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJMonopoleScatter\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心\item 使用条件  PS::MomentMonopoleScatterの使用条件に準ずる。\end{itemize}

\subsubsubsubsection{PS::SPJQuadrupoleScatter}
\label{sec:SPJQuadrupoleScatter}単極子と四重極子を情報として持つMomentクラスPS::MomentQuadrupoleScatterと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJQuadrupolepoleScatter {    public:        F64    mass;        F64vec pos;
        F64mat quad;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJQuadrupoleScatter\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心
        
  quad: 近傍でまとめた粒子の四重極子\item 使用条件  PS::MomentQuadrupoleScatterの使用条件に準ずる。\end{itemize}

\subsubsubsection{PS::SEARCH\_MODE\_LONG\_SYMMETRY}\subsubsubsubsection{PS::SPJMonopoleSymmetry}
\label{sec:SPJMonopoleSymmetry}単極子までを情報として持つMomentクラスPS::MomentMonopoleSymmetryと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJMonopoleSymmetry {    public:        F64    mass;        F64vec pos;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJMonopoleSymmetry\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心\item 使用条件  PS::MomentMonopoleSymmetryの使用条件に準ずる。\end{itemize}

\subsubsubsubsection{PS::SPJQuadrupoleSymmetry}
\label{sec:SPJQuadrupoleSymmetry}単極子と四重極子を情報として持つMomentクラスPS::MomentQuadrupoleSymmetryと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJQuadrupolepoleSymmetry {    public:        F64    mass;        F64vec pos;
        F64mat quad;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJQuadrupoleSymmetry\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心
        
  quad: 近傍でまとめた粒子の四重極子\item 使用条件  PS::MomentQuadrupoleSymmetryの使用条件に準ずる。\end{itemize}\subsubsubsection{PS::SEARCH\_MODE\_LONG\_CUTOFF}\subsubsubsubsection{PS::SPJMonopoleCutoff}
\label{sec:SPJMonopoleCutoff}単極子までを情報として持つMomentクラスPS::MomentMonopoleCutoffと対となるSuperParticleJクラス。以下、このクラスの概要を記述する。\begin{screen}\begin{verbatim}namespace ParticleSimulator {    class SPJMonopoleCutoff {    public:        F64    mass;        F64vec pos;    };}\end{verbatim}\end{screen}\begin{itemize}\item クラス名  PS::SPJMonopoleCutoff\item メンバ変数とその情報  mass: 近傍でまとめた粒子の全質量、または全電荷  pos: 近傍でまとめた粒子の重心、または粒子電荷の重心\item 使用条件  PS::MomentMonopoleCutoffの使用条件に準ずる。\end{itemize}\subsubsection{必要なメンバ関数}\subsubsubsection{概要}以下ではSuperParticleJクラスを作る際に必要なメンバ関数を記述する。このときSuperParticleJクラスのクラス名をSPJとする。これは変更自由である。\subsubsubsection{SPJ::getPos}\if 0\begin{screen}\begin{verbatim}class SPJ {public:    PS::F64vec pos;    PS::F64vec getPos() const {        return this->pos;    }};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 前提}    SPJのメンバ変数posはある１つの超粒子の位置情報。このposのデータ型は  PS::F32vecまたはPS::F64vec型。  \item {\bf 引数}  なし  \item {\bf 返値}  PS::F32vec型またはPS::F64vec型。SPJクラスの位置情報を保持したメンバ  変数。  \item {\bf 機能}  SPJクラスの位置情報を保持したメンバ変数を返す。  \item {\bf 備考}  SPJクラスのメンバ変数posの変数名は変更可能。\end{itemize}\fi\begin{screen}\begin{verbatim}class SPJ {public:    PS::F64vec getPos() const;};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  なし  \item {\bf 返値}  PS::F32vec型またはPS::F64vec型。SPJクラスの位置情報を保持したメンバ  変数。  \item {\bf 機能}  SPJクラスの位置情報を保持したメンバ変数を返す。  \end{itemize}\subsubsubsection{SPJ::setPos}\if 0\begin{screen}\begin{verbatim}class SPJ {public:    PS::F64vec pos;    void setPos(const PS::F64vec pos_new) {        this->pos = pos_new;    }};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 前提}    SPJクラスのメンバ変数posは１つの粒子の位置情報。このposのデータ型は  PS::F32vecまたはPS::F64vec。\item {\bf 引数}  pos\_new: 入力。const PS::F32vecまたはconst PS::F64vec型。FDPS側で修  正した粒子の位置情報。\item {\bf 返値}  なし。  \item {\bf 機能}  FDPSが修正した粒子の位置情報をSPJクラスの位置情報に書き込む。\item {\bf 備考}  SPJクラスのメンバ変数posの変数名は変更可能。メンバ関数SPJ::setPosの  引数名pos\_newは変更可能。posとpos\_newのデータ型が異なる場合の動作  は保証しない。\end{itemize}\fi\begin{screen}\begin{verbatim}class SPJ {public:    void setPos(const PS::F64vec pos_new);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  pos\_new: 入力。const PS::F32vecまたはconst PS::F64vec型。FDPS側で修  正した粒子の位置情報。\item {\bf 返値}  なし。  \item {\bf 機能}  FDPSが修正した粒子の位置情報をSPJクラスの位置情報に書き込む。\end{itemize}\subsubsubsection{SPJ::copyFromMoment}\if 0\begin{screen}\begin{verbatim}class Mom {public:    PS::F32    mass;    PS::F32vec pos;}class SPJ {public:    PS::F32    mass;    PS::F32vec pos;    void copyFromMoment(const Mom & mom) {        mass = mom.mass;        pos  = mom.pos;    }};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 前提}  なし  \item {\bf 引数}  mom: 入力。const Mom \&型。Momにはユーザー定義またはFDPS側で用意した  Momentクラスが入る。\item {\bf 返値}  なし。  \item {\bf 機能}  Momクラスの情報をSPJクラスにコピーする。\item {\bf 備考}  Momクラスのクラス名は変更可能。MomクラスとSPJクラスのメンバ変数名は  変更可能。メンバ関数SPJ::copyFromMomentの引数名は変更可能。\end{itemize}\fi\begin{screen}\begin{verbatim}class Mom;class SPJ {public:    void copyFromMoment(const Mom & mom);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  mom: 入力。const Mom \&型。Momにはユーザー定義またはFDPS側で用意した  Momentクラスが入る。\item {\bf 返値}  なし。  \item {\bf 機能}  Momクラスの情報をSPJクラスにコピーする。\end{itemize}\subsubsubsection{SPJ::convertToMoment}\if 0\begin{screen}\begin{verbatim}class Mom {public:    PS::F32    mass;    PS::F32vec pos;    Mom(const PS::F32 m,        const PS::F32vec & p) {        mass = m;        pos  = p;    }}class SPJ {public:    PS::F32    mass;    PS::F32vec pos;    Mom convertToMoment() const {        return Mom(mass, pos);    }};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 前提}  なし  \item {\bf 引数}  なし\item {\bf 返値}  Mom型。Momクラスのコンストラクタ。  \item {\bf 機能}  Momクラスのコンストラクタを返す。\item {\bf 備考}  Momクラスのクラス名は変更可能。MomクラスとSPJクラスのメンバ変数名は  変更可能。メンバ関数SPJ::copyFromMomentの引数名は変更可能。メンバ関  数SPJ::convertToMomentで使用されるMomクラスのコンストラクタが定義さ  れている必要がある。\end{itemize}\fi\begin{screen}\begin{verbatim}class Mom;class SPJ {public:    Mom convertToMoment() const;};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  なし\item {\bf 返値}  Mom型。Momクラスのコンストラクタ。  \item {\bf 機能}    超粒子をモーメントに変換し、その変換したものをMomクラスのコンストラク  タを返す。\end{itemize}\subsubsubsection{SPJ::clear}\if 0\begin{screen}\begin{verbatim}class SPJ {public:    PS::F32    mass;    PS::F32vec pos;    void clear() {        mass = 0.0;        pos  = 0.0;    }};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 前提}  なし  \item {\bf 引数}  なし\item {\bf 返値}  なし  \item {\bf 機能}  SPJクラスのオブジェクトの情報をクリアする。\item {\bf 備考}  メンバ変数名は変更可能。\end{itemize}\fi\begin{screen}\begin{verbatim}class SPJ {public:    void clear();};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  なし\item {\bf 返値}  なし  \item {\bf 機能}  SPJクラスのオブジェクトの情報をクリアする。\end{itemize}\subsubsection{場合によっては必要なメンバ関数}\subsubsubsection{概要}本節では、場合によっては必要なメンバ関数について記述する。\subsubsubsection{LET交換時に粒子データをシリアライズして送る場合}\label{sec:SPJ:serialize}LET交換時に粒子データをシリアライズして送る場合には、メンバ関数にSPJ::packとSPJ::unpackを用意する必要がある。以下にそれぞれの規定を記述する。%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsubsection{SPJ::pack}\begin{screen}\begin{verbatim}class SPJ {public:    static PS::S32 pack(const PS::S32 n_ptcl, const SPJ *ptcl[], char *buf,                         size_t & packed_size, const size_t max_buf_size);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  n\_ptcl: LET交換時に送る粒子の数。
  

  ptcl: 送る粒子へのポインタの配列。

  buf: 送信バッファーの先頭アドレス。
  
  packed\_size: ユーザーがバッファーへ書き込むサイズ。単位はバイト。
  
  max\_buf\_size: 送信バッファーの書き込み可能な領域のサイズ。単位はバイト。\item {\bf 返値}  PS::S32型。packed\_sizeがmax\_buf\_sizeを超えた場合は-1を返す。それ  以外の場合は0を返す。  \item {\bf 機能} LET交換時に送信する粒子をシリアライズし、送信バッファーに書き込む。\end{itemize}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsubsection{SPJ::unPack}\begin{screen}\begin{verbatim}class SPJ {public:    static void unPack(const PS::S32 n_ptcl, SPJ[], const char *buf);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf 引数}  n\_ptcl: LET交換時に受け取る粒子の数。
  
  ptcl: 受け取る粒子の配列。
  
  buf: 受信バッファーの先頭アドレス。\item {\bf 返値}  なし。\item {\bf 機能} LET交換時に受信する粒子をデシリアライズし、粒子配列に書き込む。\end{itemize}
