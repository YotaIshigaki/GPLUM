\subsubsection{Summary}%EssentialParticleJクラスは相互作用の計算に必要なj粒子の情報を持つクラ%スであり、相互作用の定義(節\ref{sec:overview_action}の手順0)に必要とな%る。EssentialParticleJクラスはFullParticleクラス%(節\ref{sec:fullparticle})のサブセットである。FDPSは、このクラスのデー%タにアクセスする必要がある。このために、EssentialParticleJクラスはいく%つかのメンバ関数を持つ必要がある。以下、この節の前提、常に必要なメンバ%関数と、場合によっては必要なメンバ関数について記述する。The \texttt{EssentialParticleJ} class should contain all information ofa $j-$ particle which is necessary to calculate interaction(see step 0 in Sec. \ref{sec:overview_action}).This class is a subset of \texttt{FullParticle} (see, Sec. \ref{sec:fullparticle}).Class \texttt{EssentialParticleJ} should have required member functionswith specific names, as described below.\subsubsection{Premise}%この節の中では、EssentialParticleJクラスとしてEPJというクラスを一例と%して使う。また、FullParticleクラスの一例としてFPというクラスを使う。%EPJ, FPというクラス名は変更可能である。Let us take \texttt{EPJ} and \texttt{FP} classes as examples of\texttt{EssentialParticleJ} and \texttt{FullParticle} as below.Users can use arbitrary names in place of \texttt{EPJ} and \texttt{FP}.%EPJとFPの宣言は以下の通りである。\begin{screen}\begin{verbatim}class FP;class EPJ;\end{verbatim}\end{screen}\subsubsection{Required member functions}\subsubsubsection{Summary}%常に必要なメンバ関数はEPJ::getPosとEPJ::copyfromFPである。EPJ::getPos%はEPJクラスの位置情報をFDPSに読み込ませるための関数で、EPJ::copyFromFP%はFPクラスの情報をEPJクラスに書きこむ関数である。これら%のメンバ関数の記述例と解説を以下に示す。The member functions \texttt{EPJ::getPos} and \texttt{EPJ::copyFromForce} are required.\texttt{EPJ::getPos} returns the position of a particle to FDPS.\texttt{EPJ::copyFromFP} copies the information necessary for the interaction calculation from \texttt{FullParticle}.The examples and descriptions for these member functions are listed below.\subsubsubsection{EPJ::getPos}\begin{screen}\begin{verbatim}class EPJ {public:    PS::F64vec getPos() const;};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  None.  \item {\bf Returns}  %PS::F64vec型。EPJクラスの位置情報を保持したメンバ変数。  \texttt{PS::F64vec}.  Returns the position of a particle of \texttt{EPJ} class.\end{itemize}\subsubsubsection{EPJ::copyFromFP}\begin{screen}\begin{verbatim}class FP;class EPJ {public:    void copyFromFP(const FP & fp);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  %fp: 入力。const FP \&型。FPクラスの情報を持つ。  \texttt{fp}: Input. \texttt{const FP \&} type.\item {\bf Returns}  None.  \item {\bf Behaviour}  %FPクラスの持つ１粒子の情報の一部をEPJクラスに書き込む。  Copies the part of information of \texttt{FP} to \texttt{EPJ}.\end{itemize}\subsubsection{Required member functions for specific cases}\subsubsubsection{Summary}%本節では、場合によっては必要なメンバ関数について記述する。相互作用ツリー%クラスのPS::SEARCH\_MODE型にPS::SEARCH\_MODE\_LONG以外を用いる場合に必%要なメンバ関数、列挙型のBOUNDARY\_CONDITION型に%PS::BOUNDARY\_CONDITION\_OPEN以外を選んだ場合に必要となるメンバ関数に%ついて記述する。なお、既存のMomentクラスやSuperParticleJクラスを用いる%際に必要となるメンバ変数はこれら既存のクラスの節を参照のこと。In this section we describe the member functions in the case that the othermode than \texttt{PS::SEARCH\_MODE\_LONG} as \texttt{PS::SEARCH\_MODE} or\texttt{PS::BOUNDARY\_CONDITION\_OPEN} as \texttt{BOUNDARY\_CONDITION} are used.For the detailed description about pre-defined \texttt{Moment} and\texttt{SuperParticleJ} classes, see corresponding section.\subsubsubsection{Modes other than \texttt{PS::SEARCH\_MODE\_LONG} as \texttt{PS::SEARCH\_MODE} are used}\subsubsubsubsection{EPJ::getRSearch}\begin{screen}\begin{verbatim}class EPJ {public:    PS::F64 getRSearch() const;};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  None.  \item {\bf Returns}  %PS::F32型またはPS::F64型。 EPJクラスの近傍粒子を探す  %半径の大きさを保持したメンバ変数。  \texttt{PS::F32vec} or \texttt{PS::F64vec}.  Returns the value of the member variable which contains neighbor search radius in \texttt{EPJ}. When using \texttt{PS::SEARCH\_MODE\_LONG\_CUTOFF}, all EPJ must return the same value as the cutoff radius.\end{itemize}\subsubsubsection{Modes other than \texttt{PS::BOUNDARY\_CONDITION\_OPEN} are used \texttt{BOUNDARY\_CONDITION}}\subsubsubsubsection{EPJ::setPos}\begin{screen}\begin{verbatim}class EPJ {public:    void setPos(const PS::F64vec pos_new);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  %pos\_new: 入力。const PS::F32vecまたはconst PS::F64vec型。FDPS側で修  %正した粒子の位置情報。  \texttt{pos\_new}: Input. \texttt{const PS::F32vec} or \texttt{const PS::F64vec}.  Modified positions of particle by FDPS.\item {\bf Returns}  None.  \item {\bf Behaviour}  %FDPSが修正した粒子の位置情報をEPJクラスの位置情報に書き込む。  Replaces the positions in \texttt{EPJ} class by those modified by FDPS.\end{itemize}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsection{Obtian EPJ from id of particle}\subsubsubsubsection{EPJ::getId}\label{sec:EPJ:getId}\begin{screen}\begin{verbatim}class EPJ {public:    PS::S64 getId();};\end{verbatim}\end{screen}\begin{itemize}\item {\bf arguments}void.\item {\bf returned value}Type PS::S64.  \item {\bf function}This function is needed when user program uses PS::TreeForForce::getEpjFromId().For more information, please see \ref{sec:getEpjFromId}.%PS::TreeForForce::getEpjFromId()を使用する場合に必要。詳しく%は\ref{sec:getEpjFromId}を参照。\end{itemize}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsection{Serialize particle data when LET exchange}\label{sec:EPJ:serialize}

Member functions \texttt{EPJ::pack} and \texttt{EPJ::unpack} are necessary, if serializing particle data when LET exchange. Below, we describe the specifications for these functions.%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsubsection{EPJ::pack}\begin{screen}\begin{verbatim}class EPJ {public:    static PS::S32 pack(const PS::S32 n_ptcl, const EPJ *ptcl[], char *buf,                         size_t & packed_size, const size_t max_buf_size);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  \texttt{n\_ptcl}: Number of particles to be sent when LET exchange. 
  
  \texttt{ptcl}: Array of pointers to particles to be sent. 
  \texttt{buf}: Beginning address of a send buffer. 
  \texttt{packed\_size}: Size to be written to the send buffer by the user (in bytes). 
  \texttt{max\_buf\_size}: Size of writable area of the send buffer (in bytes).\item {\bf Returns}  Type \texttt{PS::S32}. Returns -1 if \texttt{packed\_size} is greater than \texttt{max\_buf\_size}. Otherwise, returns 0.  \item {\bf Behaviour}  This function serializes the data of particles to be sent when LET exchange and writes them to a send buffer.\end{itemize}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\subsubsubsubsection{EPJ::unPack}\begin{screen}\begin{verbatim}class EPJ {public:    static void unPack(const PS::S32 n_ptcl, EPJ ptcl[],
                       const char *buf);};\end{verbatim}\end{screen}\begin{itemize}\item {\bf Arguments}  \texttt{n\_ptcl}: Number of particles received when LET exchange. 
                         \texttt{ptcl}: Array of particles to store the received particles.
                         \texttt{buf}: Beginning address of a receive buffer.\item {\bf Returns}  None.\item {\bf Behaviour} This function deserializes received particle data when LET exchange and write them to an array of particles. For details, see \S~\ref{sec:treeForForceHighLevelAPI}. When failing to deserialize, it calls PS::Abort() and the program is terminated.\end{itemize}