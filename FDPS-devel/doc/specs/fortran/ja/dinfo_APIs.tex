本節では、第\ref{chap:overview}章で説明した領域情報クラスのオブジェクト(以後、\textbf{領域情報オブジェクト}と呼ぶ)に関するAPIについて説明する。FDPS本体において、領域情報オブジェクトは、領域情報を保持し、領域分割を行うAPIを提供する。Fortran/C言語 インターフェースを用いたプログラムでは、領域情報オブジェクトを識別番号で管理する。

領域情報オブジェクトを操作する全APIの名称の一覧を以下に示す:
\begin{screen}
\begin{spverbatim}
(fdps_)create_dinfo
(fdps_)delete_dinfo
(fdps_)init_dinfo
(fdps_)get_dinfo_time_prof
(fdps_)clear_dinfo_time_prof
(fdps_)set_nums_domain
(fdps_)set_boundary_condition
(fdps_)get_boundary_condition
(fdps_)set_pos_root_domain
(fdps_)collect_sample_particle
(fdps_)decompose_domain
(fdps_)decompose_domain_all
\end{spverbatim}  
\end{screen}
ここで、\texttt{(fdps\_)}の意味は前節冒頭で述べた通りである。

以下、順に、各APIの仕様を記述する。
\clearpage

%=============================================================
\subsection{create\_dinfo}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%create_dinfo(dinfo_num)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_create_dinfo(int *dinfo_num);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入出力 & 領域情報オブジェクトの識別番号を受け取るための変数。{\setnoko\uc{C言語では変数のアドレスを引数に指定する必要があることに注意}}。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
領域情報オブジェクトをメモリ上に生成し、そのオブジェクトの識別番号を返す。
\clearpage

%=============================================================
\subsection{delete\_dinfo}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%delete_dinfo(dinfo_num)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_delete_dinfo(const int dinfo_num);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
識別番号\texttt{dinfo\_num}の領域情報オブジェクトをメモリから消去する。
\clearpage

%=============================================================
\subsection{init\_dinfo}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%init_dinfo(dinfo_num,coef_ema)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_init_dinfo(const int dinfo_num,
                     const float coef_ema);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{coef\_ema} & real(kind=c\_float) & 入力 & 指数移動平均の平滑化係数。Fortranの場合、この引数は省略可能で、省略された場合、デフォルト値は$1$が使用される。C言語の場合、変数の値が$<0$ または $>1$の場合、自動的にFortranのデフォルト値が使用される。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
領域情報オブジェクトを初期化し、指数移動平均の平滑化係数を設定する。この係数の許される値は0から1である。それ以外の値を入れた場合はエラーメッセージを送出しプログラムは終了する。大きくなるほど、最新の粒子分布の情報が領域分割に反映されやすい。1の場合、最新の粒子分布の情報のみ反映される。0の場合、最初の粒子分布の情報のみ反映される。１度は呼ぶ必要がある。過去の粒子分布の情報を領域分割に反映する必要がある理由については、Ishiyama, Fukushige \& Makino (2009, Publications of the Astronomical Society of Japan, 61, 1319)を参照のこと。

\clearpage

%=============================================================
\subsection{get\_dinfo\_time\_prof}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%get_dinfo_time_prof(dinfo_num,prof)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_get_dinfo_time_prof(const int dinfo_num,
                              fdps_time_prof *prof);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{prof} & type(fdps\_time\_prof) & 入出力 & 領域情報オブジェクトのAPIでかかった時間を受け取るための変数。{\setnoko\uc{C言語では引数に変数のアドレスを指定する必要があることに注意}}。 \\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
領域情報オブジェクトのAPIである\texttt{(fdps\_)collect\_sample\_particle}と\texttt{(fdps\_)decompose\_domain}にかかった時間(ミリ秒単位)を\texttt{fdps\_time\_prof}型変数のメンバ変数である\texttt{collect\_sample\_particles}と\texttt{decompose\_domain}に格納する。

\clearpage

%=============================================================
\subsection{clear\_dinfo\_time\_prof}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%clear_dinfo_time_prof(dinfo_num)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_clear_dinfo_time_prof(const int dinfo_num);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
FDPS本体に用意された識別番号 \texttt{dinfo\_num} の領域情報オブジェクトのTimeProfile型プライベートメンバ変数のメンバ変数\texttt{collect\_sample\_particles}と\texttt{decompose\_domain}の値を0クリアする。ここで、TimeProfile型はFortran/C言語インターフェースで用意された\texttt{fdps\_time\_prof}型に対応するC++のデータ型のことである(詳細は、FDPS本体の仕様書を参照)。本APIは時間計測をリセットするために使用する。

\clearpage

%=============================================================
\subsection{set\_nums\_domain}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%set_nums_domain(dinfo_num,nx,ny,nz)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_set_nums_domain(const int dinfo_num,
                          const int nx,
                          const int ny,
                          const int nz);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{nx} & integer(kind=c\_int) & 入力 & $x$軸方向のルートドメインの分割数。\\
\texttt{ny} & integer(kind=c\_int) & 入力 & $y$軸方向のルートドメインの分割数。\\
\texttt{nz} & integer(kind=c\_int) & 入力 & $z$軸方向のルートドメインの分割数で、デフォルトは1。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
計算領域の分割する方法を設定する。\texttt{nx}, \texttt{ny}, \texttt{nz}はそれぞれ$x$軸、$y$軸、$z$軸方向の計算領域の分割数である。呼ばなければ自動的に\texttt{nx}, \texttt{ny}, \texttt{nz}が決まる。呼んだ場合に入力する\texttt{nx}, \texttt{ny}, \texttt{nz}の総積がMPIプロセス数と等しくなければ、FDPSはエラーメッセージを送り、プログラムを止める。

\clearpage

%=============================================================
\subsection{set\_boundary\_condition}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%set_boundary_condition(dinfo_num,bc)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_set_boundary_condition(const int dinfo_num,
                                 const int bc);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{bc} & integer(kind=c\_int) & 入力 & 境界条件を与えるための変数。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
境界条件の設定をする。許される入力は、第\ref{sec:enum_types}節で説明した境界条件型である。すなわち、Fortranでは、\texttt{fdps\_bc\_open}(開境界)、\texttt{fdps\_bc\_periodic\_x}と\texttt{fdps\_bc\_periodic\_y}と\texttt{fdps\_bc\_periodic\_z}(それぞれ$x$, $y$, $z$軸のみ周期境界でそれ以外が開境界)、\texttt{fdps\_bc\_periodic\_xy}と\texttt{fdps\_bc\_periodic\_xz}と\texttt{fdps\_bc\_periodic\_yz}(それぞれ$xy$, $xz$, $yz$軸のみ周期境界でそれ以外が開境界)、fdps\_bc\_periodic\_xyz($xyz$軸すべて周期境界)、\texttt{fdps\_bc\_shearing\_box}(シアリングボックス)、\texttt{fdps\_bc\_user\_defined}(ユーザー定義の境界条件)である。ただし、\texttt{fdps\_bc\_shearing\_box}と\texttt{fdps\_bc\_user\_defined}は未実装である。C言語でも上記に対応する境界条件型が用意されているので、それらのみ指定可能である。

\clearpage

%=============================================================
\subsection{get\_boundary\_condition}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
function fdps_ctrl%set_boundary_condition(dinfo_num)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
int fdps_get_boundary_condition(const int dinfo_num);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
integer(kind=c\_int)型のスカラー値。

\subsubsection*{機能}
現在設定されている境界条件の情報を整数値として返す。取りうる値は境界条件型(第\ref{sec:enum_types}節参照)の各列挙子に対応する整数である。

\clearpage

%=============================================================
\subsection{set\_pos\_root\_domain}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%set_pos_root_domain(dinfo_num,low,high)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_set_pos_root_domain(const int dinfo_num,
                              const fdps_f32vec *low,
                              const fdps_f32vec *high);
\end{spverbatim}
\end{screen}

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cp{8cm}cX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{low} & Fortranの場合、以下のいずれか: & 入力 & \multirow{6}{\hsize}{ルートドメインの下限(閉境界)。}\\
& real(kind=c\_float), dimension(space\_dim) &&\\
& real(kind=c\_double), dimension(space\_dim) &&\\
& type(fdps\_f32vec) &&\\
& type(fdps\_f64vec) &&\\
& C言語では \textbf{\texttt{fdps\_f32vec *}型のみ} &&\\
\texttt{high} & \texttt{low}と同じ & 入力 & ルートドメインの上限(開境界)。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
計算領域の下限と上限を設定する。開放境界条件の場合は呼ぶ必要はない。それ以外の境界条件の場合は、呼ばなくても動作するが、その結果が正しいことは保証できない。\texttt{high}の座標の各値は\texttt{low}の対応する座標よりも大きくなければならない。そうでない場合は、FDPSはエラーメッセージを送出し、ユーザープログラムを終了させる。
\clearpage

%=============================================================
\subsection{collect\_sample\_particle}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%collect_sample_particle(dinfo_num, &
                                             psys_num,  &
                                             clear,     &
                                             weight)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_collect_sample_particle(const int dinfo_num,
                                  const int psys_num,
                                  const _Bool clear,
                                  const float weight);
\end{spverbatim}
\end{screen}

\clearpage

\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{psys\_num} & integer(kind=c\_int) & 入力 & 領域分割のためのサンプル粒子を提供する粒子群オブジェクトの識別番号を与えるための変数。 \\
\texttt{clear} & logical(kind=c\_bool) & 入力 & 前にサンプルされた粒子情報をクリアするかどうかを決定するフラグ。.true. {\small (Fortranの場合)}/true {\small (C言語の場合)}でクリアする。Fortranでは、この引数は省略可能であり、省略された場合のデフォルト値は.true.である。 \\
\texttt{weight} & real(kind=c\_float) & 入力 & 領域分割のためのサンプル粒子数を決めるためのウェイト。Fortranでは、この引数は省略可能であり、省略された場合のデフォルト値はこのAPIを呼び出したプロセスが担当する粒子数となる。C言語では負の値が入力された場合、自動的にFortranにおけるデフォルト値が設定される。プロセス$i$のウェイトを$w_{i}$、API \texttt{(fdps\_)set\_nptcl\_smpl}で設定されたプロセスあたりのサンプル粒子数を$n_{\mathrm{smpl}}$、プロセス数を$n_{\mathrm{proc}}$とすると、プロセス$i$からは$n_{\mathrm{smpl}}n_{\mathrm{proc}}(w_{i}/\sum_{k} w_{k})$個の粒子数がサンプルされる。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
識別番号 \texttt{psys\_num}の粒子群オブジェクトから粒子をサンプルする。\texttt{clear}によってこれより前にサンプルした粒子の情報を消すかどうか決める。\texttt{weight}によってそのMPIプロセスからサンプルする粒子の量を調整する(\texttt{weight}が大きいほどサンプル粒子数が多い)。

\clearpage

%=============================================================
\subsection{decompose\_domain}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%decompose_domain(dinfo_num)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_decompose_domain(const int dinfo_num);
\end{spverbatim}
\end{screen}


\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
計算領域の分割を実行する。

\clearpage

%=============================================================
\subsection{decompose\_domain\_all}
\subsubsection*{Fortran 構文}
\begin{screen}
\begin{spverbatim}
subroutine fdps_ctrl%decompose_domain_all(dinfo_num, &
                                          psys_num,  &
                                          weight)
\end{spverbatim}
\end{screen}

\subsubsection*{C言語 構文}
\begin{screen}
\begin{spverbatim}
void fdps_decompose_domain_all(const int dinfo_num, 
                               const int psys_num,  
                               const float weight); 
\end{spverbatim}
\end{screen}



% 仮引数
\subsubsection*{仮引数仕様}
\begin{table}[h]
\begin{tabularx}{\linewidth}{cccX}
\toprule
\rowcolor{Snow2}
仮引数名 & データ型 & 入出力属性 & 定義 \\
\midrule
\texttt{dinfo\_num} & integer(kind=c\_int) & 入力 & 領域情報オブジェクトの識別番号を与えるための変数。\\
\texttt{psys\_num} & integer(kind=c\_int) & 入力 & 領域分割のためのサンプル粒子を提供する粒子群オブジェクトの識別番号を与えるための変数。 \\
\texttt{weight} & real(kind=c\_float) & 入力 & 領域分割のためのサンプル粒子数を決めるためのウェイト。ウェイトの意味とデフォルト値については、API \texttt{(fdps\_)collect\_sample\_particle}を参照。\\
\bottomrule
\end{tabularx}
\end{table}

\subsubsection*{返り値}
なし

\subsubsection*{機能}
識別番号 \texttt{psys\_num}の粒子群オブジェクトから粒子をサンプルし、続けてルートドメインの分割を行う。すなわち、領域情報オブジェクトのAPIである\texttt{(fdps\_)collect\_sample\_particle}と\texttt{(fdps\_)decompose\_domain}が行うことをこのAPIは一度に行う。

\clearpage
